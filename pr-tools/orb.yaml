version: 2.1

description: |
  mojaloop/pr-tools is a CircleCI orb for convenience functions and utilities in Mojaloop CI/CD pipelines

executors:
  default-docker:
    working_directory: /home/circleci/project
    docker:
      - image: node:12.16.1-alpine

commands:
  pr-title-check:
    description: Check the title of a Github pull request
    # parameters:
    steps:
      - run:
          name: Install general dependencies
          command: |
            # TODO: trim these down
            apk --no-cache add git
            apk --no-cache add ca-certificates
            apk --no-cache add curl
            apk --no-cache add openssh-client
            apk add --no-cache -t build-dependencies make gcc g++ python libtool autoconf automake jq
            npm config set unsafe-perm true
            npm install -g node-gyp
      # Orbs don't let you package anything more than basic shell scripts
      # so we bootstrap this orb by checking out the code in the repo
      # TODO: checkout based on deterministic git tag
      - run:
          name: checkout ci-config repo
          command: |
            git clone -b feat/pr-title-orb https://github.com/mojaloop/ci-config.git
            cd ci-config/pr-tools && npm install
      - run:
          name: Check the PR title
          command: |
            echo "${CIRCLE_PULL_REQUESTS}"
            echo "${CIRCLE_PULL_REQUEST}"
            ls -la
            cd ci-config && ls -la &&  ./pr-tools/_pr_title.js